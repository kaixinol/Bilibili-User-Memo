<div
  x-data="panelShell"
  x-init="init()"
  x-show="true"
  class="panel-container"
  :class="{ open: isOpen, closed: !isOpen }"
  @keydown.window="handleSelectAll($event)"
  x-cloak
>
  <div class="panel-inner" x-data="panelSettings">
    <button
      class="panel-toggle-btn"
      title="右键点击修改文本~"
      x-data="panelToggleBtn"
      @click="togglePanel()"
      @contextmenu.prevent="editToggleText()"
      x-text="isOpen ? openText : closeText"
      :style="isOpen ? 'opacity: 1;' : 'opacity: 0.3;'"
    ></button>
    <div class="panel-mode-section">
      <div class="panel-mode-label">昵称显示模式：</div>
      <template x-for="mode in displayModes" :key="mode.value">
        <div class="panel-mode-option">
          <input
            type="radio"
            name="memoMode"
            :value="mode.value"
            :id="`panel-memo-mode-${mode.value}`"
            x-model.number="displayModeProxy"
          />
          <label :for="`panel-memo-mode-${mode.value}`" x-text="mode.label"></label>
        </div>
      </template>

      <div class="panel-right-actions">
        <label
          class="panel-custom-color-setting"
          @click="closeAdvancedCss()"
          @contextmenu="handleColorSettingContextMenu($event)"
          @mousedown="handleColorSettingMouseDown($event)"
        >
          <span
            class="setting-text"
            title="左键自定义颜色&#10;右键自定义样式&#10;中键清除自定义样式"
            >自定义备注颜色</span
          >
          <div class="color-preview"></div>

          <input
            type="color"
            class="ghost-color-picker"
            x-model="customFontColor"
            @input="onCustomColorInput()"
          />
        </label>
      </div>
      <div class="panel-theme-toggle" @click="toggleTheme()">
        <svg
          x-show="!isDark"
          alt="sun"
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <circle cx="12" cy="12" r="4" />
          <path d="M12 2v2" />
          <path d="M12 20v2" />
          <path d="m4.93 4.93 1.41 1.41" />
          <path d="m17.66 17.66 1.41 1.41" />
          <path d="M2 12h2" />
          <path d="M20 12h2" />
          <path d="m6.34 17.66-1.41 1.41" />
          <path d="m19.07 4.93-1.41 1.41" />
        </svg>
        <svg
          x-show="isDark"
          alt="moon"
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path
            d="M20.985 12.486a9 9 0 1 1-9.473-9.472c.405-.022.617.46.402.803a6 6 0 0 0 8.268 8.268c.344-.215.825-.004.803.401"
          />
        </svg>
      </div>
    </div>

    <div class="panel-control-bar" x-data="panelActions">
      <button x-bind="panelImportBtn">导入</button>
      <button x-bind="panelMultiSelectBtn">
        <span x-show="!userList.isMultiSelect">多选用户</span>
        <span x-show="userList.isMultiSelect">退出多选</span>
      </button>
      <button
        class="panel-icon-btn"
        x-show="userList.isMultiSelect"
        x-transition.opacity.scale
        :disabled="userList.selectedIds.length === 0"
        @click="confirmRemoveSelected()"
        title="删除所选用户"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M10 11v6" />
          <path d="M14 11v6" />
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6" />
          <path d="M3 6h18" />
          <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
        </svg>
        <span class="panel-icon-text" x-show="userList.isMultiSelect"
          >已选 <span x-text="userList.selectedIds.length"></span
        ></span>
      </button>
      <div class="panel-title">备注列表</div>
      <button x-bind="panelRefreshBtn">
        <span x-show="!userList.isRefreshing">⚡一键刷新数据</span>

        <span x-show="userList.isRefreshing" class="refresh-content">
          <span class="loading-spinner">⏳</span>
          正在刷新 (<span x-text="userList.refreshCurrent"></span>/<span
            x-text="userList.refreshTotal"
          ></span
          >)
        </span>
      </button>
      <div class="panel-search-box">
        <input
          id="searchInput"
          placeholder="搜索昵称、备注或ID..."
          class="panel-search-input"
          x-model.debounce.200ms="userList.searchQuery"
        />
        <button x-bind="panelSearchClearBtn" x-transition.opacity>
          ×
        </button>
      </div>
      <button x-bind="panelExportBtn">导出</button>
    </div>

    <div
      class="panel-custom-css-section"
      x-show="showAdvancedCss"
      x-transition.origin.top.duration.150ms
    >
      <div class="panel-custom-css-title">自定义备注样式（CSS）</div>
      <textarea
        x-ref="memoCssInput"
        class="panel-custom-css-input"
        x-model="customMemoCss"
        @input.debounce.700ms="applyMemoCss()"
        @blur="applyMemoCss()"
        placeholder="示例：
.bili-memo-tag {
  font-style: italic;
  letter-spacing: 0.5px;
}
.editable-textarea {
  background: rgba(0,0,0,0.08);
  border-bottom: 2px solid currentColor;
}"
      ></textarea>
      <div
        class="panel-custom-css-status"
        x-show="cssStatus"
        x-transition.opacity
        role="status"
        aria-live="polite"
        x-text="cssStatus"
      ></div>
      <div class="panel-custom-css-hint">
        这里支持完整 CSS 选择器。只影响备注相关元素时，建议用 .bili-memo-tag /
        .editable-textarea / .bili-memo-input
      </div>
    </div>

    <div class="panel-users-container">
      <div class="panel-users-list">
        <template x-for="user in $store.userList.filteredUsers" :key="user.id">
          ${boxTemplate}
        </template>

        <div x-show="$store.userList.filteredUsers.length === 0" class="panel-empty-state">
          没有找到用户
        </div>
      </div>
    </div>
  </div>
</div>
